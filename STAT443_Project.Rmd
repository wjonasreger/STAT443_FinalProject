---
title: "STAT 443 Project"
author: "Subin Cho, updated by jackie"
date: "3/5/2021"
output:
  html_document:
    df_print: paged
---

```{r echo = FALSE, warning = FALSE}
library(dplyr, warn.conflicts = FALSE)
library(ggplot2)
library(tidyverse)
```

```{r}
# read data: Gas Turbine CO and NOx Emission
gt_2012 = read.csv('gt_2012.csv', sep = ',')
```

```{r}
str(gt_2012)
```

The dataset contains 7628 instances of 11 sensor measures aggregated over one hour (by means of average or sum) from a gas turbine in 2012 located in Turkey's north western region for the purpose of studying flue gas emissions, namely CO and NOx (NO + NO2).

- `AT`: Ambient temperature (C)
- `AP`: Ambient pressure (mbar) 
- `AH`: Ambient humidity (%) 

- `AFDP`: Air filter difference pressure (mbar)
- `GTEP`: Gas turbine exhaust pressure (mbar)
- `TIT`: Turbine inlet temperature (C)
- `TAT`: Turbine after temperature (C)
- `CDP`: Compressor discharge pressure (mbar)

- `TEY`: Turbine energy yield (MWH)

- `CO`: Carbon monoxide (mg/m3)
- `NOX`: Nitrogen oxides (mg/m3)


```{r echo = FALSE}
# AT, AP, AH
p_AT = gt_2012 %>% 
  ggplot(aes(x = AT)) +
  geom_density(color = 'dodgerblue') + theme(legend.position = "none")

p_AP = gt_2012 %>% 
  ggplot(aes(x = AP)) +
  geom_density(color = 'dodgerblue') + theme(legend.position = "none")

p_AH = gt_2012 %>% 
  ggplot(aes(x = AH)) +
  geom_density(color = 'dodgerblue') + theme(legend.position = "none")

# AFDP, GTEP, TIT, TAT, CDP
p_AFDP = gt_2012 %>% 
  ggplot(aes(x = AFDP)) +
  geom_density(color = 'darkred') + theme(legend.position = "none")

p_GTEP = gt_2012 %>% 
  ggplot(aes(x = GTEP)) +
  geom_density(color = 'darkred') + theme(legend.position = "none")

p_TIT = gt_2012 %>% 
  ggplot(aes(x = TIT)) +
  geom_density(color = 'darkred') + theme(legend.position = "none")

p_TAT = gt_2012 %>% 
  ggplot(aes(x = TAT)) +
  geom_density(color = 'darkred') + theme(legend.position = "none")

p_CDP = gt_2012 %>% 
  ggplot(aes(x = CDP)) +
  geom_density(color = 'darkred') + theme(legend.position = "none")

# TEY
p_TEY = gt_2012 %>% 
  ggplot(aes(x = TEY)) +
  geom_density(color = 'darkgreen') + theme(legend.position = "none")

# CO, NOX
p_CO = gt_2012 %>% 
  ggplot(aes(x = CO)) + 
  geom_density(color = 'darkorange') + theme(legend.position = "none")

p_NOX = gt_2012 %>% 
  ggplot(aes(x = NOX)) +
  geom_density(color = 'darkorange') + theme(legend.position = "none")
```

```{r, fig.height = 15, fig.width = 15, echo = FALSE}
gridExtra::grid.arrange(p_AT, p_AP, p_AH,
                        p_AFDP, p_GTEP, p_TIT, p_TAT, p_CDP,
                        p_TEY,
                        p_CO, p_NOX, ncol = 3)
```

## CO emissions
```{r}
mod_co1 = lm(CO ~ . - NOX, data = gt_2012)
summary(mod_co1)
```

```{r}
# remove AFDP
mod_co2 = lm(CO ~ . - NOX - AFDP, data = gt_2012)
summary(mod_co2)
```

- Backward Search
```{r}
# BIC
mod_co_back1 = step(mod_co2, direction = "backward")
coef(mod_co_back1)
```
```{r}
# AIC
mod_co_start = lm(CO ~ 1 - NOX, data = gt_2012)
mod_co_forw_aic = step(mod_co_start, 
  scope = CO ~ AT + AP + AH + AFDP + GTEP + TIT + TAT + TEY + CDP, 
  direction = "forward")
```
```{r}
# stepwise
mod_co_start = lm(CO ~ 1 - NOX, data = gt_2012)
mod_co_both_aic = step(mod_co_start, 
  scope = CO ~ AT + AP + AH + AFDP + GTEP + TIT + TAT + TEY + CDP, 
  direction = "both")
```



## $NO_x$ emissions
```{r}
mod_nox1 = lm(NOX ~ . - CO, data = gt_2012)
summary(mod_nox1)
```

```{r}
# Is this our another response variable?
```


#Jackie's Part 
```{r}
gt <- gt_2012
```


```{r}
gt_high <- gt_2012 %>% filter(TEY > 160)
head(gt_high)
mod_gt_high <- lm(CO ~. - NOX, data = gt_2012)
```
```{r}
library(lmtest)
library(boot)
#write diagnostic functions for later use 
#Fitted VS Residual Test 
test_FvsR = function(model){
plot(fitted(model), resid(model), xlab = "Fitted", ylab = "Residuals", main = "Residual Plot", col = "purple")
abline(h = 0, col = "blue")}
#QQ plot & QQline
test_qq = function(model){
qqnorm(resid(model), main = "Normal Q-Q plot", col = "purple")
qqline(resid(model), col = "blue")
}
#BP test 
test_bp = function(model, alpha) {
  p_val = bptest(model)$p.value
  decision = ifelse(p_val < alpha,"Reject", "Fail to Reject")
  list1 = list(bp.p_val = p_val, bp.decision = decision)
  return(list1)
}
# Shapiroâ€“Wilk test (sw test)
test_sw = function(model, alpha) {
  p_val = shapiro.test(resid(model))$p.value
  decision = ifelse(p_val < alpha,"Reject", "Fail to Reject")
  list1 = list(sw.p_val = p_val, sw.decision = decision)
  return(list1)
}
#Calculate loocv_rmse
get_loocv_rmse = function(model) {
  sqrt(mean((resid(model) / (1 - hatvalues(model))) ^ 2))
}
#Calculate adr2
get_adj_r2 = function(model) {
  summary(model)$adj.r.squared
}
#Get number of parameters 
get_num_params = function(model) {
  length(coef(model))
}
#Run All Test Diagnostic
run_all_diagnostic = function(model, visual=TRUE, alpha=0.05){
  if (visual) {
    par(mfrow = c(1,2))
    test_FvsR(model)
    test_qq(model)
  }
  loocv_rmse = get_loocv_rmse(model)
  adj.r.squared = get_adj_r2(model)
  params = get_num_params(model)
  bp = test_bp(model, alpha)
  sw = test_sw(model, alpha)
  data_frame = data.frame(loocv_rmse, adj.r.squared, params, bp, sw, row.names = '')
  return(data_frame)
}
```


```{r}
library(faraway)
vif(mod_gt_high)
```

```{r}
#Partial Correlation Coefficient between CO and AT
model2.1 <-lm(CO ~.-AT, data = gt_high)
model2.2 <-lm(AT ~. - CO, data = gt_high)
pc_at <- cor(resid(model2.1), resid(model2.2))  
```

```{r}
#Partial Correlation Coefficient between CO and GTEP
model2.3 <-lm(CO ~.-GTEP, data = gt_high)
model2.4 <-lm(GTEP ~. - CO, data = gt_high)
pc_gtep <- cor(resid(model2.3), resid(model2.4)) 
```


```{r}
#Partial Correlation Coefficient between CO and TIT
model2_a <-lm(CO ~.-TIT, data = gt_high)
model2_b <-lm(TIT ~. - CO, data = gt_high)
pc_tit <- cor(resid(model2_a), resid(model2_b)) 
```

```{r}
#Partial Correlation Coefficient between CO and TAT
model2_c <-lm(CO ~.-TAT, data = gt_high)
model2_d <-lm(TAT ~. - CO, data = gt_high)
pc_tat <- cor(resid(model2_c), resid(model2_d)) 
```

```{r}
#Partial Correlation Coefficient between CO and TEY
model2_e <-lm(CO ~.-TEY, data = gt_high)
model2_f <-lm(TEY ~. - CO, data = gt_high)
pc_tey <- cor(resid(model2_e), resid(model2_f))
```

```{r}
#Partial Correlation Coefficient between CO and CDP
model2_g <-lm(CO ~.-CDP, data = gt_high)
model2_h <-lm(CDP ~. - CO, data = gt_high)
pc_cdp <- cor(resid(model2_g), resid(model2_h))   
```

```{r}
Variables = c('Partial Correlation_CO & AT','Partial Correlation_CO & GTEP', 'Partial Correlation_CO & TIT', 'Partial Correlation_CO & TAT', 'Partial Correlation_CO & TEY', 'Partial Correlation_CO & CDP')
Partial_Correlation = c(pc_at, pc_gtep, pc_tit, pc_tat, pc_tey, pc_cdp)
pc <- cbind.data.frame(Variables,Partial_Correlation)
pc %>% arrange(abs(Partial_Correlation)) #Remove CDO & TIT
```



```{r}
mod_h1 <- lm(CO ~. - TIT - CDP - NOX, data = gt_high)
summary(mod_h1)
```
```{r}
mod_h2 <- lm(CO ~ (AT + AP + AH + AFDP + GTEP + TAT + TEY) ^ 2 + I(AT ^2) + I(AP ^2) + I(AH ^2) + I(AFDP ^2) +I(GTEP ^ 2) + I(TAT^2) + I(TEY^2), data = gt_high)
summary(mod_h2)
```

```{r}
#Variable Selection
n = length(resid(mod_h1))
h1_back_aic = step(mod_h1, trace = FALSE)
summary(h1_back_aic)#Get rid of AT
vif(h1_back_aic) #GTEP &TAT > 10
```
```{r}
#Partial Correlation - git rid of GTEP
mod_h_getp1 <- lm(CO ~ AP + AH + AFDP + TAT + TEY, data = gt_high)
mod_h_getp2 <- lm(GTEP ~ AP + AH + AFDP + TAT + TEY, data = gt_high)
pa_gtep2 <- cor(resid(mod_h_getp1), resid(mod_h_getp2))
pa_gtep2
```



```{r}
#Partial Correlation - git rid of TAT
mod_h_tat1 <- lm(CO ~ AP + AH + AFDP + GTEP + TEY, data = gt_high)
mod_h_tat2 <- lm(TAT ~ AP + AH + AFDP + GTEP + TEY, data = gt_high)
pa_tat2 <- cor(resid(mod_h_tat1), resid(mod_h_tat2))
pa_tat2
```

```{r}
mod_h3 <- lm(CO ~ (AP + AH + AFDP + GTEP + TAT + TEY)^2, data = gt_high)
summary(mod_h3)
h3_back_aic <- step(mod_h3, trace = FALSE)
summary(h3_back_aic)
```


```{r}
n = length(resid(mod_h2))
h_back_aic = step(mod_h2, trace = FALSE)
summary(h_back_aic)
```
```{r}
h_try <- lm(CO ~  AP + AH + AFDP + GTEP + TAT + TEY  + 
    I(AFDP^2) + I(GTEP^2) + AT:AP + AT:AH + AT:TAT + AH:AFDP + AH:TAT + AH:TEY + AFDP:TEY + GTEP:TAT + GTEP:TEY + TAT:TEY, data = gt_high)
summary(h_try)

n = length(resid(h_try))
h_back_aic_try = step(h_try, trace = FALSE)
summary(h_back_aic_try)
```

