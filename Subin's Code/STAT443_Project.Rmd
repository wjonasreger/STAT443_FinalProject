---
title: "STAT 443 Project2"
author: "Subin Cho"
date: "3/19/2021"
output: pdf_document
---

```{r warning = FALSE}
# packages
library(dplyr, warn.conflicts = FALSE)
library(ggplot2)
library(skimr)
library(car, warn.conflicts = FALSE)
library(corrplot)
library(lars)
library(MASS, warn.conflicts = FALSE)
library(glmnet)
library(lmtest)
```

```{r}
# read data: Gas Turbine CO Emission
gt_initial = read.csv("gt_2012.csv")
```

The dataset contains 7628 instances of 11 sensor measures aggregated over one hour (by means of average or sum) from a gas turbine in 2012 located in Turkey's north western region for the purpose of studying flue gas emissions, namely CO and NOx (NO + NO2).

- `AT`: Ambient temperature (C)
- `AP`: Ambient pressure (mbar) 
- `AH`: Ambient humidity (%) 

- `AFDP`: Air filter difference pressure (mbar)
- `GTEP`: Gas turbine exhaust pressure (mbar)
- `TIT`: Turbine inlet temperature (C)
- `TAT`: Turbine after temperature (C)
- `CDP`: Compressor discharge pressure (mbar)

- `TEY`: Turbine energy yield (MWH)

- `CO`: Carbon monoxide (mg/m3)
- `NOX`: Nitrogen oxides (mg/m3)

```{r}
# remove NOX
gt = subset(gt_initial, select = -NOX)
colnames(gt)
```

```{r}
# Check NAs
sum(is.na(gt))
```

```{r}
# check data
rownames(gt) = NULL
head(gt, n = 10)
```

```{r}
# AT, AP, AH
p_AT = gt %>% 
  ggplot(aes(x = AT)) +
  geom_histogram(binwidth = 1, color = 'dodgerblue') + 
  theme(legend.position = "none")

p_AP = gt %>% 
  ggplot(aes(x = AP)) +
  geom_histogram(binwidth = 1, color = 'dodgerblue') + 
  theme(legend.position = "none")

p_AH = gt %>% 
  ggplot(aes(x = AH)) +
  geom_histogram(binwidth = 1, color = 'dodgerblue') + 
  theme(legend.position = "none")

# AFDP, GTEP, TIT, TAT, CDP
p_AFDP = gt %>% 
  ggplot(aes(x = AFDP)) +
  geom_histogram(binwidth = 0.1, color = 'darkred') + 
  theme(legend.position = "none")

p_GTEP = gt %>% 
  ggplot(aes(x = GTEP)) +
  geom_histogram(binwidth = 0.3, color = 'darkred') + 
  theme(legend.position = "none")

p_TIT = gt %>% 
  ggplot(aes(x = TIT)) +
  geom_histogram(binwidth = 1, color = 'darkred') + 
  theme(legend.position = "none")

p_TAT = gt %>% 
  ggplot(aes(x = TAT)) +
  geom_histogram(binwidth = 0.1, color = 'darkred') + 
  theme(legend.position = "none")

p_CDP = gt %>% 
  ggplot(aes(x = CDP)) +
  geom_histogram(binwidth = 0.1, color = 'darkred') + 
  theme(legend.position = "none")

# TEY
p_TEY = gt %>% 
  ggplot(aes(x = TEY)) +
  geom_histogram(binwidth = 1, color = 'darkgreen') + 
  theme(legend.position = "none")

# CO
p_CO = gt %>% 
  ggplot(aes(x = CO)) + 
  geom_histogram(binwidth = 1, color = 'darkorange') + 
  theme(legend.position = "none")
```

```{r, fig.height = 15, fig.width = 15}
gridExtra::grid.arrange(p_AT, p_AP, p_AH,
                        p_AFDP, p_GTEP, p_TIT, p_TAT, p_CDP,
                        p_TEY,
                        p_CO, ncol = 3)
```

```{r}
# EDA
par(mfrow = c(2, 3))
plot(CO ~ . , data = gt, cex = 0.05, col = "dodgerblue")
```

```{r}
# null vs full model
mod_null = lm(CO ~ 1, data = gt)
mod_full = lm(CO ~ ., data = gt)
anova(mod_null, mod_full)

## full model is preferred
```

```{r}
# Removing AFDP
coef(summary(mod_full))[, 4][which.max(coef(summary(mod_full))[, 4])]
```

```{r}
mod_1 = lm(CO ~ . - AFDP, data = gt)
summary(mod_1)
which(coef(summary(mod_1))[, 4] > 0.05)
```

```{r}
# new data without AFDP
gt_2 = subset(gt, select = -AFDP)
mod_1 = lm(CO ~ ., data = gt_2)
```

```{r}
# AIC
extractAIC(mod_1) ## AIC for the full model

# BIC
extractAIC(mod_1, k = log(nrow(gt_2)))

# stepwise
step(mod_1, direction = "backward", trace = 0)
```

```{r}
# Check multicollinearity issues
corrplot.mixed(cor(gt_2), lower.col = "black", number.cex = 0.7)
round(cor(gt_2), 2)
```

```{r}
vif(mod_1) # AT, GTEP, TIT, TAT, TEY, CDP are problematic

# create horizontal bar chart to display each VIF value
barplot(vif(mod_1), main = "VIF Values", horiz = TRUE, col = "lightblue")

# add vertical line at 5
abline(v = 5, lwd = 3, lty = 2)
```

```{r}
# Multicolinearity
## Principal Component Regression, Ridge Regression, Stepwise Regression
```

```{r}
# Ridge Regression
fit = lm.ridge(CO ~ ., gt_2, lambda = seq(0, 100, by = 0.1))
    
#par(mfrow = c(1,2))
matplot(coef(fit)[, -1], type = "l", xlab = "Lambda", ylab = "Coefficients")
text(rep(50, 8), coef(fit)[1,-1], colnames(gt_2)[1:8])
title("Ridge Coefficients")
    
# use GCV to select the best lambda
plot(fit$lambda[1:500], fit$GCV[1:500], type = "l", col = "darkorange", 
         ylab = "GCV", xlab = "Lambda", lwd = 3)
title("GCV")

fit$lambda[which.min(fit$GCV)]
```

```{r}
# Ridge Regression 2
set.seed(3)
fit2 = cv.glmnet(data.matrix(gt_2), gt_2$CO, 
                 nfolds = 10, alpha = 0)
coef(fit2, s = "lambda.min")

plot(fit2$glmnet.fit, "lambda")
```

```{r}
# Higher Order Terms?
```

```{r}
# Removing influential observations
cd = cooks.distance(mod_1)
#cd[which(cd > 4 / length(cd))]
length(cd[which(cd > 4 / length(cd))])

mod_1_cd = lm(CO ~ ., data = gt_2, subset = cd <= 4 / length(cd))
plot(mod_1_cd, which = 2)
```

```{r}
# calculate LOOCV RMSE
calc_loocv_rmse = function(model){
  sqrt(mean((resid(model) / (1 - hatvalues(model)))^2))
}

calc_loocv_rmse(mod_1_cd)
```

```{r}
# Breusch-Pagan Test
bptest(mod_1_cd)
```

```{r}
boxcox(mod_1_cd, plotit = TRUE, lambda = seq(0.4, 0.55, by = 0.01))
lambda = 0.47
mod_1_cox = lm((((CO ^ lambda) - 1) / lambda) ~ ., data = gt_2, 
               subset = cd <= 4 / length(cd))
```

```{r}
plot(fitted(mod_1_cox), resid(mod_1_cox), col = "dodgerblue",
     pch = 20, cex = 1, xlab = "Fitted", ylab = "Residuals")
abline(h = 0, lty = 2, col = "darkorange", lwd = 2)
```

```{r}
#??????
```


